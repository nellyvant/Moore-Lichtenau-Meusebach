---
title: "Analyse Wassertiefen"
format: html
editor: visual
---

# 1 Genutzte Packages

```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(lubridate)
library(tidyr)
```

# 2 Daten einlesen

```{r}
Wassertiefen <- read_excel("Tabelle Wassertiefe.xlsx")
summary(Wassertiefen)
str(Wassertiefen)
class(Wassertiefen$Datum)

# Datum als Date konvertieren
Wassertiefen$Datum <- as.Date(Wassertiefen$Datum)
str(Wassertiefen)
class(Wassertiefen$Datum)
```

# 3 Auswertung

```{r}
# Mittelwerte pro Tag/ pro Standort berechnen 
WT_mittel <- Wassertiefen %>%
  group_by(Datum, Standort) %>% 
  summarise(WT_mean = mean(Wassertiefe, na.rm = TRUE)) %>%
  ungroup()

```

## 3.1 Jahresverlauf der Wassertiefe (MT vs MN vs L)

```{r}
# Liniendiagramm - Jahresverlauf
ggplot(WT_mittel, aes(x = Datum, y = WT_mean, color = Standort)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  labs(
    title = "Zeitlicher Verlauf der mittleren Wassertiefe nach Standort",
    x = "Datum",
    y = "Mittlere Wassertiefe (cm)",
    color = "Standort"
  ) +
  theme_minimal() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y")
```

## 3.2 Unterschiede zwischen den Standorten

```{r}
# Boxplot - Unterschiede zw. Standorten (Tagesmittelwerte)
ggplot(WT_mittel, aes(x = factor(Standort), y = WT_mean, fill = Standort)) +
  geom_boxplot() +
  labs(
    title = "Vergleich der mittleren Wassertiefe nach Standort",
    x = "Standort",
    y = "Mittlere Wassertiefe (cm)"
  ) +
  theme_minimal()

```

```{r}
# Boxplot pro Standort, Messpunkte farblich unterscheiden
ggplot(Wassertiefen, aes(x = factor(Standort), y = Wassertiefe, fill = factor(Messpunkt))) +
  geom_boxplot(position = position_dodge(0.8)) +
  labs(title = "Vergleich der Wassertiefen nach Standort und Messstelle (Mai–Sep 2025)",
       x = "Standort",
       y = "Wassertiefe (cm)",
       fill = "Messstelle") +
  theme_minimal()

```

## 3.3 Unterschiede innerhalb eines Standortes

```{r}
####Jahresverlauf - Liniendiagramm
plot_lin <- function(df, st, titel=NULL) {
  
  # Daten  nach Standort filtern
  df_sub1 <- df %>% filter(Standort == st)

  # Automatischer Titel
  if (is.null(titel)) {
    titel <- paste("Wassertiefeschwankungen -", st)
  }
  
  ggplot(df_sub1, aes(Datum, Wassertiefe, color = factor(Messpunkt))) +
    geom_line(linewidth = 1) +
    geom_point(size = 2) +
    labs(title = titel,
         x = "Datum", y = "Wassertiefe (cm)", color = "Messstelle") +
    theme_minimal() +
    # Achse automatisch an vorhandene Daten anpassen
    scale_x_date(date_breaks = "1 month", date_labels = "%b %Y")
}



#### Unterschiede zw. den Messstellen - Boxplot 
plot_box <- function(df, st, titel=NULL, x_name=NULL) {
  
  # Daten filtern
  df_sub2 <- df %>% filter(Standort == st)
  
  # Titel setzen, falls NULL
  if (is.null(titel)) {
    titel <- paste("Wassertiefeschwankungen nach Messpunkt -", st)
  }
  
  # x-Achsenname setzen, falls NULL
  if (is.null(x_name)) {
    x_name <- "Messpunkt"  # Standard
  }
  
  ggplot(df_sub2, aes(x = factor(Messpunkt), y = Wassertiefe, fill = factor(Messpunkt))) +
    geom_boxplot() +
    labs(
      title = titel,
      x = x_name,           # hier wird der flexible Name verwendet
      y = "Wassertiefe (cm)",
      fill = "Messstelle"
    ) +
    theme_minimal()
}

```

### Meusebach trocken

```{r}
# Liniendiagramm
plot_lin(Wassertiefen, "MT", titel="Wassertiefen in Meusebach trocken Mai–September 2025")
```

```{r}
# Boxplot
plot_box(Wassertiefen, st="MT",
         titel="Messpunkte Meusebach trocken: Mai–Sep 2025",
         x_name="Meusebach trocken")
```

### Meusebach nass

```{r}
# Liniendiagramm
plot_lin(Wassertiefen, "MN", titel="Wassertiefen in Meusebach nass Mai–September 2025")
```

```{r}
# Boxplot
plot_box(Wassertiefen, st="MN",
         titel="Messpunkte Meusebach nass: Mai–Sep 2025",
         x_name="Meusebach nass")
```

### Lichtenau

```{r}
# Liniendiagramm
plot_lin(Wassertiefen, "L", titel="Wassertiefen in Lichtenau: Mai–September 2025")
```

```{r}
# Boxplot
plot_box(Wassertiefen, st="L",
         titel="Messpunkte Lichtenau: Mai–Sep 2025",
         x_name="Meusebach nass")
```

# 4 Statistische Kennzahlen

```{r}
# Statistische Kennzahlen pro Messpunkt und Standort
Kennzahlen <- Wassertiefen %>%
  group_by(Standort, Messpunkt) %>%
  summarise(
    Mittelwert = mean(Wassertiefe, na.rm = TRUE),
    Median = median(Wassertiefe, na.rm = TRUE),
    Std = sd(Wassertiefe, na.rm = TRUE),
    Min = min(Wassertiefe, na.rm = TRUE),
    Max = max(Wassertiefe, na.rm = TRUE)
  )

Kennzahlen

```

```{r}
# Statistische Kennzahlen pro Standort
Kennzahlen_standort <- Wassertiefen %>%
  group_by(Standort) %>%
  summarise(
    Mittelwert = mean(Wassertiefe, na.rm = TRUE),
    Std = sd(Wassertiefe, na.rm = TRUE),
    Min = min(Wassertiefe, na.rm = TRUE),
    Max = max(Wassertiefe, na.rm = TRUE)
  )

Kennzahlen_standort

```

# 5 Relevante Fragen

(da die Diagramme ggf. ein falsches Bild vermitteln)

### Wasserstandsschwankungen

```{r}
# welcher Standort hat die größten Wasserstandsschwankungen?

# Standardabweichung = wie stark der Wasserstand typischerweise um seinen Mittelwert schwankt
# Spannweite des Wasserstands = extremste Unterschiede zwischen dem höchsten und niedrigsten gemessenen Wasserstand

#Schwankung pro Standort (über Tagesmittelwerte)
WT_var_st <- WT_mittel %>%
  group_by(Standort) %>%
  summarise(
    sd_WT = sd(WT_mean, na.rm = TRUE),
    range_WT = max(WT_mean, na.rm = TRUE) - min(WT_mean, na.rm = TRUE)
  ) %>%
  arrange(desc(sd_WT))

WT_var_st

```

```{r}
# Schwankung pro Messpunkt innerhalb eines Standorts
WT_var_mp <- Wassertiefen %>%
  group_by(Standort, Messpunkt) %>%
  summarise(
    sd_WT = sd(Wassertiefe, na.rm = TRUE),
    range_WT = max(Wassertiefe, na.rm = TRUE) - min(Wassertiefe, na.rm = TRUE)
  ) %>%
  arrange(desc(sd_WT))

WT_var_mp
```

```{r}
# welcher Standort hat die meisten trocken gefallenen Tage, welcher die wenigsten (= Beständigkeit des Gewässers/Wasserspiegel)

# auch daraus kann man ggf ableiten, welches Gewässer das Wasser besser hält und Faktoren ableiten, warum es bei den anderen nicht so ist -> naturschutzfachliche Maßnahmen ggf ableiten/überdenken
```

# 6 Zusatz

```{r}
# Trocken- oder Hochwasserperioden zählen 
# Interpolation (da der Wasserstand nicht kontinuirlich gemessen wurde/in regelmäßigen Abständen)
library(zoo)

# Daten nach Datum sortieren und interpolieren
Wassertiefen <- Wassertiefen %>%
  arrange(Standort, Messpunkt, Datum) %>%
  group_by(Standort, Messpunkt) %>%
  mutate(Wassertiefe_interp = na.approx(Wassertiefe, x = as.numeric(Datum))) %>%
  ungroup()

# Trocken, Normalwasser, Hochwasser definieren
# Beispielwerte, noch keine konkreten festgelegt
Wassertiefen <- Wassertiefen %>%
  mutate(
    Trocken = Wassertiefe_interp < 3,
    Normalwasser = Wassertiefe_interp >= 3 & Wassertiefe_interp <= 25,
    Hochwasser = Wassertiefe_interp > 25
  )

# Zusammenhängende Perioden identifizieren
Wassertiefen <- Wassertiefen %>%
  group_by(Standort, Messpunkt) %>%
  mutate(
    Trocken_grp = cumsum(Trocken != lag(Trocken, default=first(Trocken))),
    Normalwasser_grp = cumsum(Normalwasser != lag(Normalwasser, default=first(Normalwasser))),
    Hochwasser_grp = cumsum(Hochwasser != lag(Hochwasser, default=first(Hochwasser)))
  ) %>%
  ungroup()

# Zusammenhängende Perioden zählen
Perioden_Anzahl <- Wassertiefen %>%
  group_by(Standort, Messpunkt) %>%
  summarise(
    TrockenPerioden = sum(Trocken & !duplicated(Trocken_grp)),
    NormalwasserPerioden = sum(Normalwasser & !duplicated(Normalwasser_grp)),
    HochwasserPerioden = sum(Hochwasser & !duplicated(Hochwasser_grp)),
    .groups = "drop"
  )

Perioden_Anzahl

```

```{r}
TrockenPerioden <- Wassertiefen %>%
  filter(Trocken) %>%  # nur Trockenblöcke
  group_by(Standort, Messpunkt, Trocken_grp) %>%  # nach zusammenhängenden Perioden
  summarise(
    Start = min(Datum),  # erster Tag der Periode
    Ende = max(Datum),   # letzter Tag der Periode
    Dauer_Tage = as.numeric(max(Datum) - min(Datum)) + 1,  # Dauer in Tagen
    .groups = "drop"
  )

TrockenPerioden
```

```{r}
HochwasserPerioden <- Wassertiefen %>%
  filter(Hochwasser) %>%  # nur Hochwasserblöcke
  group_by(Standort, Messpunkt, Hochwasser_grp) %>%
  summarise(
    Start = min(Datum),
    Ende = max(Datum),
    Dauer_Tage = as.numeric(max(Datum) - min(Datum)) + 1,
    .groups = "drop"
  )

HochwasserPerioden
```

```{r}
NormalwasserPerioden <- Wassertiefen %>%
  filter(Normalwasser) %>%  # nur Normalwasserblöcke
  group_by(Standort, Messpunkt, Normalwasser_grp) %>%  # bereits vorhanden!
  summarise(
    Start = min(Datum),
    Ende = max(Datum),
    Dauer_Tage = as.numeric(max(Datum) - min(Datum)) + 1,
    .groups = "drop"
  )

NormalwasserPerioden
```

```{r}
# Histogramm zur Häufigkeit der Wasserstände je Standort 
ggplot(Wassertiefen, aes(x = Wassertiefe, fill = Standort)) +
  geom_histogram(binwidth = 5, alpha = 0.7) +
  facet_wrap(~Standort) +
  theme_minimal() +
  labs(title = "Verteilung der Wasserstände pro Standort",
       x = "Wasserstand (cm)",
       y = "Anzahl der Messungen")

```

```{r}
# Histogramm zur Häufigkeit der Wasserstände je Messpunkt und Standort 
Wassertiefen$Standort <- as.factor(Wassertiefen$Standort)
Wassertiefen$Messpunkt <- as.factor(Wassertiefen$Messpunkt)

standort_L <- Wassertiefen %>% 
  filter(Standort == "L")
#standort_L <- Wassertiefen %>%
#  filter(Standort == "L", Messpunkt != "4")
standort_MN <- Wassertiefen %>% 
  filter(Standort == "MN")
standort_MT <- Wassertiefen %>% 
  filter(Standort == "MT")

ggplot(standort_MN, aes(x = Wassertiefe, fill = Messpunkt)) +
  geom_histogram(binwidth = 5, alpha = 0.7) +
  facet_wrap(~Messpunkt) +
  theme_minimal() +
  labs(title = "Histogramm pro Messpunkt & Standort",
       x = "Wasserstand (cm)",
       y = "Anzahl Messungen")

```
